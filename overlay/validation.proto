syntax = "proto3";


// Master service definition
service Master {

  // Allows streamed uploading of a .zip model to the Master
  rpc UploadFile(ModelFile) returns (UploadStatus) {}

  // Submits a validation job to the cluster
  rpc SubmitValidationJob(ValidationJobRequest) returns (ValidationJobResponse) {}

  // Registers a Worker to track
  rpc RegisterWorker (WorkerRegistrationRequest) returns (WorkerRegistrationResponse) {}

  // De-registers a Worker from tracking
  rpc DeregisterWorker (WorkerRegistrationRequest) returns (WorkerRegistrationResponse) {}
}

// Worker registration request that gets sent to the master, to be tracked
message WorkerRegistrationRequest {
  string hostname = 1;
  int32  port = 2;
}

// Worker registration response message the master sends back to the worker
message WorkerRegistrationResponse {
  bool success = 1;
}

// Worker service definition
service Worker {

  // Registers a Worker to track via heartbeats
  rpc BeginValidationJob(ValidationJobRequest) returns (ValidationJobResponse) {}
}

// Worker job request for a set of GISJOINs, and a model to validate
message ValidationJobRequest {
  string id = 1;
  string model_framework = 2;
  string model_type = 3;
  string database = 4;
  string collection = 5;
  string gis_join_key = 6;
  repeated string feature_fields = 10;
  string label_field = 7;
  bool normalize_inputs = 8;
  string validation_metric = 9;
  repeated string gis_joins = 11;
  ModelFile model_file = 12;
}

message ValidationJobResponse {
  string id = 1;
  repeated ValidationMetric metrics = 2;
}

message ValidationMetric {
  string gis_join = 1;
  double loss = 2;
  double accuracy = 3;
}

message ModelFile {
  string type = 1;
  string md5_hash = 2;
  bytes data = 3;
}

enum UploadStatusCode {
  UPLOAD_STATUS_CODE_UNKNOWN = 0;
  UPLOAD_STATUS_CODE_OK = 1;
  UPLOAD_STATUS_CODE_FAILED = 2;
}

message UploadStatus {
  string message = 1;
  string file_hash = 2;
  UploadStatusCode upload_status_code = 3;
}